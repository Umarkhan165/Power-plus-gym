{% extends "base.html" %}
{% block title %}Contact{% endblock title %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Baloo+Bhai+2:wght@400..800&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap');

        /* --- Base & Reused Styles --- */
        html { scroll-behavior: smooth; }
        body {
            background-color: #121212;
            font-family: 'Roboto Condensed', sans-serif;
            color: #e0e0e0;
            padding: 20px;
            margin: 0;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .btn {
            font-family: "Baloo Bhai 2", sans-serif;
            background-color: #a8575b;
            color: white;
            border-radius: 29px;
            border: 2px solid white;
            font-size: 18px;
            font-weight: bolder;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 3rem;
            width: 8rem;
            text-decoration: none;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            outline: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .btn:hover {
            background-color: #8c464a;
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        .btn:disabled {
            background-color: #4b2b2d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- Dashboard Specific Styles --- */
        .dashboard-container {
            max-width: 1300px;
            margin: auto;
            padding: 20px;
        }
        .dashboard-header {
            text-align: center;
            padding: 40px 0;
            background: radial-gradient(circle, #2b2b2b 0%, #121212 100%);
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            animation: fadeIn 1s ease-in-out;
        }
        .dashboard-header h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            color: #a8575b;
            font-family: "Baloo Bhai 2", sans-serif;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
        }
        .dashboard-header p {
            font-size: 1.4rem;
            color: #d4d2d2;
            font-style: italic;
        }
        .dashboard-grid {
            display: grid;
            gap: 30px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        .dashboard-card {
            background-color: #1a1a1a;
            border-radius: 15px;
            padding: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border 0.3s ease;
            position: relative;
            border: 1px solid #333;
        }
        .dashboard-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid #a8575b;
        }
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #a8575b;
            padding-bottom: 10px;
        }
        .card-header svg {
            width: 35px;
            height: 35px;
            margin-right: 15px;
            fill: #a8575b;
        }
        .card-header h3 {
            font-size: 1.8rem;
            color: white;
            font-family: 'Baloo Bhai 2', sans-serif;
        }
        .dashboard-card p {
            font-size: 1rem;
            color: #b0b0b0;
            margin-bottom: 15px;
        }
        .card-content {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            color: #d4d2d2;
            white-space: pre-wrap;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background-color: #2b2b2b;
            color: white;
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #a8575b;
            box-shadow: 0 0 5px rgba(168, 87, 91, 0.5);
        }
        .loading-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #a8575b;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-container p {
            margin-top: 10px;
            font-size: 0.9rem;
            font-style: italic;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 350px;
            justify-content: flex-end;
        }
        .chat-messages {
            list-style: none;
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 10px;
            margin-bottom: 15px;
        }
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #2b2b2b;
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 10px;
        }
        .chat-message-bubble {
            padding: 12px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 85%;
        }
        .user-message-bubble {
            background-color: #a8575b;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .ai-message-bubble {
            background-color: #2b2b2b;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        .trainer-contact img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            border: 3px solid #a8575b;
            box-shadow: 0 0 10px rgba(168, 87, 91, 0.5);
        }
        .progress-list li {
            background-color: #2b2b2b;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .more-items li {
            list-style: none;
            margin-bottom: 10px;
        }
        .more-items li a {
            color: #d4d2d2;
            text-decoration: none;
            transition: color 0.3s ease;
            display: block;
            padding: 5px;
            border-radius: 8px;
        }
        .more-items li a:hover {
            color: #a8575b;
            background-color: #2b2b2b;
        }
        .footer {
            text-align: center;
            padding: 40px 0 20px;
            color: #b0b0b0;
            font-size: 0.9rem;
            margin-top: 50px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>Welcome Back, <span > {{ current_user.username }}</span>!</h1>
            <p>Your personalized fitness journey awaits.</p>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
        </header>

        <section class="dashboard-grid">
            
            <!-- AI Diet Plan Generator -->
            <div class="dashboard-card" id="diet-card">
                <div class="card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zM12 6c-1.103 0-2 .897-2 2s.897 2 2 2 2-.897 2-2-.897-2-2-2zm-3 8c0-.552.448-1 1-1h4c.552 0 1 .448 1 1v2c0 .552-.448 1-1 1h-4c-.552 0-1-.448-1-1v-2z"></path></svg>
                    <h3>Diet Plan Generator</h3>
                </div>
                <p>Generate a custom diet plan based on your goals and preferences.</p>
                <div class="form-group">
                    <input type="text" id="dietaryGoal" placeholder="e.g., 2000 calories, high-protein">
                </div>
                <button class="btn" onclick="generateDietPlan()">Generate Plan</button>
                <div class="loading-container" id="diet-loading-container">
                    <div class="loading-spinner"></div>
                </div>
                <div class="card-content" id="dietPlanOutput" style="margin-top: 20px;"></div>
            </div>

            <!-- AI Workout Generator -->
            <div class="dashboard-card" id="workout-card">
                <div class="card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13.91l-2.45-2.45-1.42 1.42 3.87 3.87 1.41-1.41zM15.42 16.58l-1.41 1.41 1.41 1.41 2.82-2.82-1.41-1.41zM12 18h-2v2h2v-2zM4 14h2v2h-2zM4 18h2v2h-2v-2zM8 14h2v2h-2v-2zM8 18h2v2h-2v-2zM12 4h2v2h-2v-2zM12 8h2v2h-2v-2zM12 12h2v2h-2v-2zM16 4h2v2h-2v-2zM16 8h2v2h-2v-2zM16 12h2v2h-2v-2zM4 4h2v2h-2v-2zM4 8h2v2h-2v-2zM8 4h2v2h-2v-2zM8 8h2v2h-2v-2z"></path></svg>
                    <h3>Workout Routine</h3>
                </div>
                <p>Create a customized workout based on your fitness goals.</p>
                <div class="form-group">
                    <input type="text" id="workoutFocus" placeholder="e.g., Legs & Core, Cardio, Full-Body">
                </div>
                <button class="btn" onclick="generateWorkout()">Generate Workout</button>
                <div class="loading-container" id="workout-loading-container">
                    <div class="loading-spinner"></div>
                </div>
                <div class="card-content" id="workoutOutput" style="margin-top: 20px;"></div>
            </div>

            <!-- Trainer & Progress -->
            <div class="dashboard-card">
                <div class="card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm-4-4h4c1.66 0 3-1.34 3-3V7c0-1.1-.9-2-2-2H7.5c-1.38 0-2.5 1.12-2.5 2.5v.5h4c.55 0 1 .45 1 1s-.45 1-1 1H5v2c0 1.1.9 2 2 2h3zm11.5-2.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5z"></path></svg>
                    <h3>Contact Your Trainer</h3>
                </div>
                <div class="trainer-contact" style="text-align: center;">
                    <img src="https://placehold.co/150x150/a8575b/ffffff?text=Trainer" alt="Trainer Profile">
                    <h4>Alex Rodriguez</h4>
                    <p style="margin-bottom: 25px;">Expert in strength and nutrition.</p>
                    <a href="mailto:alex.rodriguez@example.com" class="btn">Message Trainer</a>
                </div>
            </div>
            
            <!-- AI Chat Assistant -->
            <div class="dashboard-card chat-container" id="chat-card">
                <div class="card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 4H3c-1.103 0-2 .897-2 2v12c0 1.103.897 2 2 2h18c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-9 14.5c-.825 0-1.5-.675-1.5-1.5s.675-1.5 1.5-1.5 1.5.675 1.5 1.5-.675 1.5-1.5 1.5zm6.5-1.5c.825 0 1.5-.675 1.5-1.5s-.675-1.5-1.5-1.5-1.5.675-1.5 1.5.675 1.5 1.5 1.5zM6.5 17c.825 0 1.5-.675 1.5-1.5S7.325 14 6.5 14s-1.5.675-1.5 1.5.675 1.5 1.5 1.5z"></path></svg>
                    <h3>AI Fitness Coach</h3>
                </div>
                <ul id="chat-messages" class="chat-messages"></ul>
                <div class="form-group" style="margin-bottom: 0;">
                    <input type="text" id="chat-input" placeholder="Ask a question..." onkeypress="handleKeyPress(event)">
                </div>
            </div>

            <!-- Progress Tracker -->
            <div class="dashboard-card">
                <div class="card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zm-1-13h2v6h-2zm-3 0h2v6h-2zm6 0h2v6h-2z"></path></svg>
                    <h3>Progress Tracker</h3>
                </div>
                <p>Track your weight to monitor your progress.</p>
                <form id="progressForm" onsubmit="addProgress(event)">
                    <div class="form-group" style="margin-bottom: 0;">
                        <input type="number" id="weight" placeholder="Enter weight (lbs)" step="0.1" required>
                    </div>
                    <button type="submit" class="btn" style="width: 100%; margin-top: 15px;">Log Weight</button>
                </form>
                <ul id="progressLog" class="progress-list" style="margin-top: 20px;"></ul>
                <p id="progressMessage" style="color: #a8575b; text-align: center; margin-top: 15px; display: none;"></p>
            </div>
            
            <!-- More Resources -->
            <div class="dashboard-card more-items">
                <div class="card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 4H3c-1.103 0-2 .897-2 2v12c0 1.103.897 2 2 2h18c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-1 14H4V6h16v12zm-8-2v-4h-4v4h4zm-2-2H8v-2h2v2z"></path></svg>
                    <h3>More Resources</h3>
                </div>
                <ul>
                    <li><a href="#">Read our latest fitness blog posts</a></li>
                    <li><a href="#">Learn about proper form and technique</a></li>
                    <li><a href="#">Explore new workout routines</a></li>
                    <li><a href="#">Connect with the community</a></li>
                </ul>
            </div>

        </section>
        
    </div>

    <footer class="footer">
        <p>&copy; 2024 MyGym. All rights reserved.</p>
    </footer>

    <script>
        const apiKey = "AIzaSyCZtw4dk42jK9SpSIqkma3FYU33Vuez6m4";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        document.addEventListener('DOMContentLoaded', () => {
            const username = 'John Doe';
            document.getElementById('username').textContent = username;

            // Progress Tracker Logic
            const progressForm = document.getElementById('progressForm');
            const progressLog = document.getElementById('progressLog');
            const progressMessage = document.getElementById('progressMessage');
            window.addProgress = (event) => {
                event.preventDefault();
                const weightInput = document.getElementById('weight');
                const weight = weightInput.value;
                const date = new Date().toLocaleDateString();

                if (weight) {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>${date}: ${weight} lbs</span><span style="color: #a8575b; font-weight: bold;"> &check;</span>`;
                    progressLog.prepend(listItem);
                    weightInput.value = '';
                    progressMessage.textContent = 'Progress logged successfully!';
                    progressMessage.style.display = 'block';
                    setTimeout(() => progressMessage.style.display = 'none', 3000);
                } else {
                    progressMessage.textContent = 'Please enter a valid weight.';
                    progressMessage.style.color = 'red';
                    progressMessage.style.display = 'block';
                    setTimeout(() => progressMessage.style.display = 'none', 3000);
                }
            };

            // AI Chat Assistant Logic
            const chatMessages = document.getElementById('chat-messages');
            const initialMessage = document.createElement('li');
            initialMessage.className = 'chat-message-bubble ai-message-bubble';
            initialMessage.textContent = 'Hello! I\'m your AI fitness coach. How can I assist you today?';
            chatMessages.appendChild(initialMessage);
        });

        // --- Utility Functions for Gemini API ---
        async function fetchWithExponentialBackoff(url, options, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) {
                        return response;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                } catch (error) {
                    console.error('Fetch error:', error);
                    throw error;
                }
            }
            throw new Error('Max retries exceeded.');
        }

        async function generateContent(prompt, cardId, outputId) {
            const card = document.getElementById(cardId);
            const outputElement = document.getElementById(outputId);
            const button = card.querySelector('.btn');
            const loadingContainer = card.querySelector('.loading-container');

            outputElement.textContent = '';
            button.disabled = true;
            loadingContainer.style.display = 'flex';

            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, options);
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response. Please try again.";
                outputElement.textContent = generatedText;
            } catch (error) {
                console.error("Error generating content:", error);
                outputElement.textContent = "Error: Could not connect to the AI service. Please try again later.";
            } finally {
                loadingContainer.style.display = 'none';
                button.disabled = false;
            }
        }

        window.generateDietPlan = () => {
            const goal = document.getElementById('dietaryGoal').value;
            if (!goal) {
                document.getElementById('dietPlanOutput').textContent = "Please enter your dietary goal.";
                return;
            }
            const prompt = `Generate a 7-day diet plan for someone with the following goal: "${goal}". Include three meals and one snack per day. The format should be clear and easy to follow.`;
            generateContent(prompt, 'diet-card', 'dietPlanOutput');
        };
        
        window.generateWorkout = () => {
            const focus = document.getElementById('workoutFocus').value;
            if (!focus) {
                document.getElementById('workoutOutput').textContent = "Please enter your workout focus.";
                return;
            }
            const prompt = `Create a detailed workout routine for a gym-goer focusing on "${focus}". The routine should include exercises, sets, and reps. Provide clear instructions for each exercise.`;
            generateContent(prompt, 'workout-card', 'workoutOutput');
        };

        window.handleKeyPress = async (event) => {
            if (event.key === 'Enter') {
                const chatInput = document.getElementById('chat-input');
                const message = chatInput.value.trim();
                const messagesList = document.getElementById('chat-messages');

                if (!message) return;

                const userMessageItem = document.createElement('li');
                userMessageItem.className = 'chat-message-bubble user-message-bubble';
                userMessageItem.textContent = message;
                messagesList.appendChild(userMessageItem);
                chatInput.value = '';
                messagesList.scrollTop = messagesList.scrollHeight;

                const loadingContainer = document.getElementById('chat-card').querySelector('.loading-container');
                loadingContainer.style.display = 'flex';

                const payload = {
                    contents: [{ role: "user", parts: [{ text: message }] }]
                };
                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                try {
                    const response = await fetchWithExponentialBackoff(apiUrl, options);
                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    const result = await response.json();
                    const aiResponseText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response. Please try again.";
                    
                    const aiMessageItem = document.createElement('li');
                    aiMessageItem.className = 'chat-message-bubble ai-message-bubble';
                    aiMessageItem.textContent = aiResponseText;
                    messagesList.appendChild(aiMessageItem);
                    messagesList.scrollTop = messagesList.scrollHeight;

                } catch (error) {
                    console.error("Error in AI chat:", error);
                    const errorMessageItem = document.createElement('li');
                    errorMessageItem.className = 'chat-message-bubble ai-message-bubble';
                    errorMessageItem.textContent = "Error: Could not connect to the AI service.";
                    messagesList.appendChild(errorMessageItem);
                } finally {
                    loadingContainer.style.display = 'none';
                }
            }
        };
    </script>
</body>
{% endblock %}